upstream tinywebserver_backend {
    server 127.0.0.1:9006;  # 根据实际端口调整
    # server 127.0.0.1:9007;  # 如需负载均衡可添加多个
}

server {
    listen 80;
    server_name 47.108.192.163;
    
    # 访问日志
    access_log /var/log/nginx/tinywebserver.access.log;
    error_log /var/log/nginx/tinywebserver.error.log;
    
    # 静态资源直接由nginx处理（性能优化）
    location /static/ {
        alias /root/workspace/TinyWebServer/root/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # CSS文件
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=utf-8";
        }
        
        # JS文件
        location ~* \.js$ {
            add_header Content-Type "application/javascript; charset=utf-8";
        }
    }
    
    # 媒体文件直接服务
    location ~* \.(jpg|jpeg|png|gif|ico|pdf|mp4)$ {
        root /root/workspace/TinyWebServer/root/;
        expires 7d;
        add_header Cache-Control "public";
        try_files $uri @backend;
    }
    
    # HTML页面直接服务  
    location ~* \.(html)$ {
        root /root/workspace/TinyWebServer/root/;
        try_files $uri @backend;
    }
    
    # Gitea代理路由
    location /gitea/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Git操作需要的设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_redirect off;
        
        # 支持大文件推送
        client_max_body_size 100M;
    }

    # 博客API路由
    location /blog/ {
        proxy_pass http://tinywebserver_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 博客功能可能需要较长处理时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # CGI登录/注册处理
    location ~ ^/[023]$ {
        proxy_pass http://tinywebserver_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # POST请求体
        client_max_body_size 1M;
    }
    
    # 数字路由页面 (/1, /5, /6, /7等)
    location ~ ^/[1567]$ {
        proxy_pass http://tinywebserver_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 根目录和其他请求
    location / {
        proxy_pass http://tinywebserver_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Session支持
        proxy_set_header Cookie $http_cookie;
    }
    
    # 后端不可达时的fallback
    location @backend {
        proxy_pass http://tinywebserver_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# HTTPS配置（可选 - 需要SSL证书后启用）
# server {
#     listen 443 ssl;
#     server_name 47.108.192.163;
#     
#     ssl_certificate /path/to/cert.pem;
#     ssl_certificate_key /path/to/key.pem;
#     
#     # SSL配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS;
#     ssl_prefer_server_ciphers off;
#     
#     # 其他location配置与HTTP相同...
# }