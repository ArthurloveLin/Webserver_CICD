# =============================================================================
# CI/CD Pipeline - é‡æ„åçš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²æµæ°´çº¿
# =============================================================================
# æµç¨‹ï¼šå•å…ƒæµ‹è¯• -> é›†æˆæµ‹è¯• -> Dockeræ‰“åŒ…å‘å¸ƒ -> éƒ¨ç½²
# æ¯ä¸ªé˜¶æ®µèŒè´£æ˜ç¡®ï¼Œä¾èµ–å…³ç³»æ¸…æ™°

name: CI/CD Pipeline

# =============================================================================
# è§¦å‘æ¡ä»¶
# =============================================================================
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

# =============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# =============================================================================
env:
  DOCKER_IMAGE: tinywebserver
  DOCKER_TAG: latest

# =============================================================================
# ä½œä¸šå®šä¹‰
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # ä½œä¸š1: å•å…ƒæµ‹è¯• - å¿«é€Ÿçš„ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡
  # ---------------------------------------------------------------------------
  unit-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache build dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/vcpkg
          ~/.cache/ccache
          /tmp/build-cache
        key: ${{ runner.os }}-deps-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
        restore-keys: |
          ${{ runner.os }}-deps-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libmysqlclient-dev \
          libssl-dev \
          libgtest-dev \
          ccache

    - name: Setup ccache
      run: |
        export CCACHE_DIR=~/.cache/ccache
        export CC="ccache gcc"
        export CXX="ccache g++"
        ccache --set-config=max_size=2G
        ccache --zero-stats

    - name: Build project
      run: |
        rm -rf build-unit
        mkdir -p build-unit
        cd build-unit
        export CC="ccache gcc"
        export CXX="ccache g++"
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                 -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        make server -j$(nproc)

    - name: Build unit tests
      run: |
        cd build-unit
        make tests -j$(nproc)

    - name: Run unit tests
      run: |
        cd build-unit
        ./tests
      env:
        # å•å…ƒæµ‹è¯•ä¸éœ€è¦çœŸå®æ•°æ®åº“è¿æ¥
        DB_HOST: mock
        DB_USER: mock
        DB_PASSWORD: mock
        DB_NAME: mock

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build-unit/server
          build-unit/tests
        retention-days: 1

  # ---------------------------------------------------------------------------
  # ä½œä¸š2: é›†æˆæµ‹è¯• - æµ‹è¯•å®Œæ•´ç³»ç»ŸåŠŸèƒ½ï¼ŒåŒ…å«æ•°æ®åº“äº¤äº’
  # ---------------------------------------------------------------------------
  integration-test:
    needs: unit-test
    runs-on: ubuntu-latest
    
    # MySQLæœåŠ¡å®¹å™¨
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: webserver123
          MYSQL_DATABASE: webserver
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./build

    - name: Make executables runnable
      run: |
        chmod +x ./build/server
        chmod +x ./build/tests

    - name: Install test tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl mysql-client netcat-openbsd

    - name: Wait for MySQL
      run: |
        echo "Waiting for MySQL to be ready..."
        timeout 60 bash -c '
        while ! mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"webserver123" --silent; do
          echo "MySQL not ready yet..."
          sleep 2
        done'
        echo "MySQL is ready!"

    - name: Setup test database
      run: |
        echo "Setting up test database schema..."
        mysql -h 127.0.0.1 -P 3306 -u root -pwebserver123 webserver < database_migration_final.sql
        echo "Database setup completed"

    - name: Start server for integration testing
      run: |
        cd build
        echo "Starting server in background..."
        ./server > server.log 2>&1 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾…30ç§’ï¼‰
        echo "Waiting for server to start..."
        timeout=30
        while [ $timeout -gt 0 ]; do
          if nc -z localhost 8080; then
            echo "Server is listening on port 8080!"
            break
          fi
          echo "Waiting... ($timeout seconds left)"
          sleep 1
          timeout=$((timeout-1))
        done
        
        if [ $timeout -eq 0 ]; then
          echo "Server failed to start within 30 seconds"
          echo "Server log:"
          cat server.log
          exit 1
        fi
        
        # é¢å¤–ç­‰å¾…ç¡®ä¿æœåŠ¡å™¨å®Œå…¨å‡†å¤‡å¥½
        sleep 3
      env:
        DB_HOST: 127.0.0.1
        DB_USER: root
        DB_PASSWORD: webserver123
        DB_NAME: webserver

    - name: Run integration tests
      run: |
        echo "Starting integration tests..."
        
        # æµ‹è¯•1: åŸºæœ¬è¿é€šæ€§
        echo "Test 1: Basic connectivity"
        if curl -f -s http://localhost:8080/ > /dev/null; then
          echo "âœ“ Server is responding"
        else
          echo "âœ— Server connectivity test failed"
          exit 1
        fi
        
        # æµ‹è¯•2: é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨index.htmlï¼‰
        echo "Test 2: Static file serving"
        curl -f -s http://localhost:8080/index.html > /dev/null && echo "âœ“ Static file serving works" || echo "â„¹ Static file test skipped (file may not exist)"
        
        # æµ‹è¯•3: ç”¨æˆ·æ³¨å†Œæ¥å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "Test 3: User registration"
        response=$(curl -s -w "%{http_code}" -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "username=testuser$(date +%s)&password=testpass123" \
          http://localhost:8080/register -o /dev/null)
        
        if [ "$response" = "200" ] || [ "$response" = "302" ] || [ "$response" = "201" ]; then
          echo "âœ“ User registration endpoint works (HTTP $response)"
        else
          echo "â„¹ User registration test: HTTP $response (endpoint may not exist or have different behavior)"
        fi
        
        # æµ‹è¯•4: ç”¨æˆ·ç™»å½•æ¥å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "Test 4: User login"
        response=$(curl -s -w "%{http_code}" -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "username=admin&password=admin" \
          http://localhost:8080/login -o /dev/null)
          
        if [ "$response" = "200" ] || [ "$response" = "302" ] || [ "$response" = "401" ]; then
          echo "âœ“ User login endpoint works (HTTP $response)"
        else
          echo "â„¹ User login test: HTTP $response (endpoint may not exist or have different behavior)"
        fi
        
        # æµ‹è¯•5: æ•°æ®åº“è¿æ¥éªŒè¯ï¼ˆé€šè¿‡æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼‰
        echo "Test 5: Database connection verification"
        if grep -q -i "mysql\|database\|connected" build/server.log; then
          echo "âœ“ Database connection appears to be working"
        else
          echo "â„¹ Database connection status unclear from logs"
        fi
        
        echo "Integration tests completed successfully!"

    - name: Show server logs on failure
      if: failure()
      run: |
        echo "=== Server Log ==="
        cat build/server.log || echo "No server log found"
        
        echo "=== MySQL Status ==="
        mysql -h 127.0.0.1 -P 3306 -u root -pwebserver123 -e "SELECT 1" || echo "MySQL connection failed"

    - name: Cleanup server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          echo "Stopping server (PID: $SERVER_PID)"
          kill $SERVER_PID 2>/dev/null || true
          sleep 2
          kill -9 $SERVER_PID 2>/dev/null || true
          echo "Server stopped"
        fi

  # ---------------------------------------------------------------------------
  # ä½œä¸š3: Dockeré•œåƒæ„å»ºå’Œå‘å¸ƒ
  # ---------------------------------------------------------------------------
  docker-build-and-push:
    needs: [unit-test, integration-test]
    runs-on: ubuntu-latest
    # åªåœ¨æ¨é€ä»£ç æˆ–å‘å¸ƒç‰ˆæœ¬æ—¶è¿è¡Œï¼ŒPRæ—¶åªæ„å»ºä¸æ¨é€
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
        # æ·»åŠ æ„å»ºå‚æ•°ï¼Œå¯ä»¥ä¼ é€’ç‰ˆæœ¬ä¿¡æ¯ç­‰
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ steps.meta.outputs.version }}

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Image scan (security check)
      uses: anchore/scan-action@v3
      id: scan
      with:
        image: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}
        severity-cutoff: high
        fail-build: false

    - name: Upload scan results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}

  # ---------------------------------------------------------------------------
  # ä½œä¸š4: éƒ¨ç½²ï¼ˆä»…åœ¨Releaseæ—¶æ‰§è¡Œï¼‰
  # ---------------------------------------------------------------------------
  deploy:
    needs: [unit-test, integration-test, docker-build-and-push]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to production
      run: |
        echo "ğŸš€ Deploying version ${{ github.event.release.tag_name }} to production"
        echo "Docker image: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.event.release.tag_name }}"
        
        # è¿™é‡Œæ˜¯éƒ¨ç½²å‘½ä»¤çš„ç¤ºä¾‹ï¼Œéœ€è¦æ ¹æ®å®é™…éƒ¨ç½²ç¯å¢ƒä¿®æ”¹
        # ä¾‹å¦‚ï¼š
        # - é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨æ›´æ–°docker-compose.yml
        # - ä½¿ç”¨Kuberneteséƒ¨ç½²
        # - ä½¿ç”¨äº‘æœåŠ¡å•†çš„éƒ¨ç½²API
        
        echo "Deployment would execute here..."
        echo "Example commands:"
        echo "  ssh user@server 'cd /app && docker-compose pull && docker-compose up -d'"
        echo "  kubectl set image deployment/webserver webserver=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.event.release.tag_name }}"

    - name: Notify deployment success
      run: |
        echo "âœ… Deployment completed successfully"
        echo "Version: ${{ github.event.release.tag_name }}"
        echo "Environment: production"
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€Slackæ¶ˆæ¯ã€é‚®ä»¶ç­‰

  # ---------------------------------------------------------------------------
  # ä½œä¸š5: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¹¶è¡Œè¿è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
  # ---------------------------------------------------------------------------
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run static analysis
      run: |
        echo "Running static code analysis..."
        cppcheck --enable=warning,style --error-exitcode=0 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --suppress=uninitMemberVar \
          --suppress=uninitMemberVarPrivate \
          --suppress=noCopyConstructor \
          --suppress=noOperatorEq \
          --suppress=noExplicitConstructor \
          --suppress=cstyleCast \
          --suppress=shadowVariable \
          --suppress=shadowFunction \
          --suppress=passedByValue \
          --suppress=unusedFunction \
          --suppress=unusedPrivateFunction \
          --suppress=unusedVariable \
          --suppress=unreadVariable \
          --suppress=constVariable \
          --suppress=constVariablePointer \
          --suppress=variableScope \
          --suppress=syntaxError \
          --suppress=uninitvar \
          --suppress=uninitStructMember \
          --suppress=useInitializationList \
          --suppress=uselessCallsSubstr \
          --suppress=nullPointerRedundantCheck \
          --suppress=checkersReport \
          --inline-suppr \
          --std=c++11 \
          --language=c++ \
          --xml --xml-version=2 \
          *.cpp *.h \
          http/*.cpp http/*.h \
          log/*.cpp log/*.h \
          CGImysql/*.cpp CGImysql/*.h \
          blog/*.cpp blog/*.h \
          timer/*.cpp timer/*.h \
          2> cppcheck-report.xml || echo "Static analysis completed"

    - name: Upload analysis results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-report
        path: cppcheck-report.xml
        retention-days: 7

# =============================================================================
# æµæ°´çº¿æ‰§è¡Œæµç¨‹æ€»ç»“:
# 
# 1. è§¦å‘æ¡ä»¶: Pushåˆ°main/developåˆ†æ”¯ã€PRåˆ°mainåˆ†æ”¯ã€æˆ–Releaseå‘å¸ƒ
# 
# 2. å¹¶è¡Œæ‰§è¡Œ:
#    - unit-test: å¿«é€Ÿå•å…ƒæµ‹è¯•ï¼ˆçº¦2-5åˆ†é’Ÿï¼‰
#    - code-quality: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰
# 
# 3. é¡ºåºæ‰§è¡Œ:
#    - integration-test: ä¾èµ–unit-testï¼Œå®Œæ•´ç³»ç»Ÿæµ‹è¯•ï¼ˆçº¦5-10åˆ†é’Ÿï¼‰
#    - docker-build-and-push: ä¾èµ–unit-testå’Œintegration-testï¼ˆçº¦10-15åˆ†é’Ÿï¼‰
#    - deploy: ä»…åœ¨Releaseæ—¶æ‰§è¡Œï¼Œä¾èµ–å‰é¢æ‰€æœ‰ä½œä¸šï¼ˆçº¦2-5åˆ†é’Ÿï¼‰
# 
# 4. æ€»è€—æ—¶ä¼°ç®—:
#    - PR: çº¦10-15åˆ†é’Ÿï¼ˆunit-test + integration-test + code-qualityï¼‰
#    - Push: çº¦20-30åˆ†é’Ÿï¼ˆåŒ…å«Dockeræ„å»ºï¼‰
#    - Release: çº¦25-35åˆ†é’Ÿï¼ˆåŒ…å«éƒ¨ç½²ï¼‰
# 
# 5. å¤±è´¥ç­–ç•¥:
#    - unit-testå¤±è´¥ â†’ æ•´ä¸ªæµæ°´çº¿åœæ­¢
#    - integration-testå¤±è´¥ â†’ Dockeræ„å»ºä¸ä¼šæ‰§è¡Œ
#    - code-qualityå¤±è´¥ â†’ ä¸å½±å“å…¶ä»–ä½œä¸šï¼ˆè®¾ç½®ä¸ºwarningï¼‰
# =============================================================================
